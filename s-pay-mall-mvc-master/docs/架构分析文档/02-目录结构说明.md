# 目录结构说明

## 项目根目录结构

```
s-pay-mall-mvc-master/
├── docs/                          # 文档和部署配置
│   ├── dev-ops/                   # 开发运维配置
│   │   ├── docker-compose-app.yml # 应用 Docker Compose 配置
│   │   ├── docker-compose-environment.yml # 环境 Docker Compose 配置
│   │   ├── mysql/                 # MySQL 配置
│   │   │   └── sql/
│   │   │       └── s-pay-mall.sql # 数据库建表 SQL
│   │   ├── nginx/                 # Nginx 配置
│   │   │   └── html/              # 静态页面
│   │   ├── redis/                 # Redis 配置
│   │   └── natapp/                # 内网穿透工具
│   └── release/                   # 生产环境配置
│       └── ...                    # 类似 dev-ops 结构
├── pom.xml                        # 父 POM 文件，管理所有子模块
└── [子模块]/
```

## Maven 多模块结构

### 1. s-pay-mall-common（公共模块）
**功能**: 提供公共的常量、异常、响应封装、工具类

```
s-pay-mall-common/
└── src/main/java/cn/bugstack/common/
    ├── constants/
    │   └── Constants.java              # 枚举常量（响应码、订单状态等）
    ├── exception/
    │   └── AppException.java           # 自定义异常
    ├── response/
    │   └── Response.java                # 统一响应封装
    └── weixin/
        ├── MessageTextEntity.java      # 微信消息实体
        ├── SignatureUtil.java          # 微信签名工具
        └── XmlUtil.java                # XML 工具类
```

**职责**:
- 定义业务常量（订单状态、响应码）
- 统一异常处理
- 统一 API 响应格式
- 微信相关工具类

---

### 2. s-pay-mall-domain（领域模型模块）
**功能**: 定义业务领域对象，不依赖其他业务模块

```
s-pay-mall-domain/
└── src/main/java/cn/bugstack/domain/
    ├── po/                             # Persistence Object - 持久化对象
    │   └── PayOrder.java               # 支付订单实体（对应数据库表）
    ├── req/                            # Request - 请求对象
    │   ├── ShopCartReq.java            # 购物车请求
    │   └── WeixinQrCodeReq.java        # 微信二维码请求
    ├── res/                            # Response - 响应对象
    │   ├── PayOrderRes.java            # 支付订单响应
    │   ├── WeixinQrCodeRes.java        # 微信二维码响应
    │   └── WeixinTokenRes.java         # 微信 Token 响应
    └── vo/                             # Value Object - 值对象
        ├── ProductVO.java              # 商品信息
        └── WeixinTemplateMessageVO.java # 微信模板消息
```

**职责**:
- 定义数据模型（PO、VO、Req、Res）
- 业务对象封装，与数据库结构解耦
- 领域对象不依赖其他业务逻辑

---

### 3. s-pay-mall-dao（数据访问层模块）
**功能**: 数据库访问接口，定义数据操作

```
s-pay-mall-dao/
└── src/main/java/cn/bugstack/dao/
    └── IOrderDao.java                  # 订单数据访问接口
```

**职责**:
- 定义数据访问接口（MyBatis Mapper）
- 不包含实现，实现由 MyBatis 提供
- 与数据库表结构映射

---

### 4. s-pay-mall-service（服务层模块）
**功能**: 业务逻辑实现

```
s-pay-mall-service/
└── src/main/java/cn/bugstack/service/
    ├── IOrderService.java              # 订单服务接口
    ├── ILoginService.java              # 登录服务接口
    ├── impl/                           # 服务实现类
    │   ├── OrderServiceImpl.java       # 订单服务实现
    │   └── WeixinLoginServiceImpl.java # 微信登录服务实现
    ├── rpc/                            # RPC 远程调用
    │   └── ProductRPC.java             # 商品服务 RPC（模拟）
    └── weixin/
        └── IWeixinApiService.java      # 微信 API 服务接口
```

**职责**:
- 实现业务逻辑
- 调用 DAO 层进行数据操作
- 集成第三方服务（支付宝、微信）
- 事件发布（支付成功事件）

---

### 5. s-pay-mall-web（Web 层模块）
**功能**: Web 入口，Controller、配置、启动类

```
s-pay-mall-web/
├── src/main/java/cn/bugstack/
│   ├── Application.java                # Spring Boot 启动类
│   ├── config/                         # 配置类
│   │   ├── AliPayConfig.java           # 支付宝配置
│   │   ├── AliPayConfigProperties.java # 支付宝配置属性
│   │   ├── GuavaConfig.java            # Guava 缓存配置
│   │   └── Retrofit2Config.java        # Retrofit2 HTTP 客户端配置
│   ├── controller/                     # 控制器层
│   │   ├── AliPayController.java       # 支付宝支付控制器
│   │   ├── LoginController.java        # 登录控制器
│   │   ├── WeixinPortalController.java # 微信公众号回调控制器
│   │   ├── XxxController.java          # 其他控制器
│   │   └── dto/
│   │       └── CreatePayRequestDTO.java # 创建支付请求 DTO
│   ├── job/                            # 定时任务
│   │   ├── NoPayNotifyOrderJob.java    # 检测未支付回调任务
│   │   └── TimeoutCloseOrderJob.java   # 超时关单任务
│   └── listener/                       # 事件监听器
│       └── OrderPaySuccessListener.java # 支付成功监听器
├── src/main/resources/
│   ├── application.yml                 # 主配置文件
│   ├── application-dev.yml            # 开发环境配置
│   ├── application-test.yml           # 测试环境配置
│   ├── application-prod.yml           # 生产环境配置
│   ├── logback-spring.xml             # 日志配置
│   └── mybatis/
│       ├── config/
│       │   └── mybatis-config.xml      # MyBatis 配置
│       └── mapper/
│           └── pay_order_mapper.xml    # 订单 Mapper XML
└── src/test/java/                      # 测试代码
    └── cn/bugstack/test/
```

**职责**:
- 接收 HTTP 请求
- 调用 Service 层处理业务
- 返回响应数据
- 配置管理（支付宝、微信、数据库等）
- 定时任务调度
- 事件监听处理

---

## 模块依赖关系

```
s-pay-mall-web (Web 层)
    ├── 依赖 s-pay-mall-service (服务层)
    │       ├── 依赖 s-pay-mall-domain (领域模型)
    │       └── 依赖 s-pay-mall-dao (数据访问层)
    │               └── 依赖 s-pay-mall-domain (领域模型)
    └── 依赖 s-pay-mall-common (公共模块)
            └── 所有模块都可以依赖
```

## 设计模式说明

### 1. 分层架构
- **Controller 层**: 处理 HTTP 请求，参数验证，响应封装
- **Service 层**: 业务逻辑处理，事务管理，调用外部服务
- **Dao 层**: 数据访问，SQL 执行
- **Domain 层**: 领域模型定义

### 2. 依赖方向
```
Web → Service → Dao → Database
  ↓      ↓
Common ← Domain
```

所有模块都依赖 `common` 模块，但不应该反向依赖（common 不依赖其他业务模块）。

### 3. 模块职责分离
- **common**: 通用工具，可被所有模块使用
- **domain**: 领域模型，独立于其他业务逻辑
- **dao**: 数据访问接口，只关心数据操作
- **service**: 业务逻辑，组合 DAO 和外部服务
- **web**: 应用入口，组合 Service 层功能

